SenzaInfo:
  StackName: cassandra
  Parameters:
    - ClusterName:
        Description: "Cluster name"
    - ClusterSize:
        Description: "The initial size (number of nodes) for the new Cassandra cluster"
    - DataCenter:
        Description: "The name of the datacenter for cassandra-rackdc.properties."
    - Image:
        Description: "Which Image to use"
    - OpsCenterIp:
        Description: "Register to Opscenter using Ip address"
    - ScalyrKey:
        Description: "The API key of Scalyr logging service used by Taupage"
    - ApplicationId:
        Description: "The application id according to yourturn"
    - SecurityGroup:
        Description: "Security group with Cassandra ports open."
    - Role:
        Description: "A role with EBS permissions."
    - Seeds:
        Description: "Seed nodes' IPs."

SenzaComponents:

  - Configuration:
      Type: Senza::StupsAutoConfiguration

  - CassandraCluster:
      Type: Senza::TaupageAutoScalingGroup
      InstanceType: c4.2xlarge # EBS-optimized
      SecurityGroups:
        - {{Arguments.SecurityGroup}}"
      IamRoles:
        - {{Arguments.Role}}"
      AutoScaling:
        Minimum: "{{Arguments.ClusterSize}}"
        Maximum: "{{Arguments.ClusterSize}}"
        MetricType: CPU
      TaupageConfig:
        root: true
        runtime: Docker
        networking: host
        source: "{{Arguments.Image}}"
        application_id: "{{Arguments.ApplicationId}}"
        # etcd_discovery_domain: "{{Arguments.EtcdDomain}}"
        scalyr_account_key: "{{Arguments.ScalyrKey}}"
        # http://docs.datastax.com/en/opscenter/5.0/opsc/reference/opscPorts_r.html
        ports:
          7000: 7000
          7199: 7199
          8778: 8778
          9042: 9042
          9160: 9160
          61621: 61621

        # Taupage's ec2.get_all_volumes(status=available) might lead to disk mixup
        # if two or more instances attempt to reattach their volumes at the same time.
        volumes:
          ebs:
            /dev/xvdf: cassandra-data-volume
            /dev/xvdg: cassandra-commitlog-volume
        # To be prepared beforehand
        mounts:
          /var/cassandra/data/data:
            partition: /dev/xvdf
            erase_on_boot: false
            filesystem: ext4
          /var/cassandra/data/commitlog:
            partition: /dev/xvdg
            erase_on_boot: false
            filesystem: ext4

        environment:
          CLUSTER_NAME: "{{Arguments.ClusterName}}"
          DATACENTER: "{{Arguments.DataCenter}}"
          OPSCENTER: "{{Arguments.OpsCenterIp}}"
          TTL: 120
          APPLICATION_ID: "{{Arguments.ApplicationId}}"
          DATA_DIR: /var/cassandra/data/data
          COMMIT_LOG_DIR: /var/cassandra/data/commitlog
          SNITCH: GossipingPropertyFileSnitch
          SEEDS: "{{Arguments.Seeds}}"

